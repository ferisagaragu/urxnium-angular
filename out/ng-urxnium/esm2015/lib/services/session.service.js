import { Inject, Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';
import { HttpHeaders } from '@angular/common/http';
import { map } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class SessionService {
    constructor(http, baseUrl) {
        this.http = http;
        this.baseUrl = baseUrl;
        this.onSignIn = new BehaviorSubject(false);
        this.count = true;
        this.firstSignIn = false;
        this.user = JSON.parse(localStorage.getItem('user'));
    }
    signIn(session, user) {
        localStorage.setItem('token', session.token);
        localStorage.setItem('expiration', session.expiration.toString());
        localStorage.setItem('expirationDate', session.expirationDate.toString());
        localStorage.setItem('refreshToken', session.refreshToken);
        localStorage.setItem('user', JSON.stringify(user));
        this.user = user;
        this.onSignIn.next(true);
        this.firstSignIn = true;
    }
    signOut() {
        localStorage.clear();
        this.onSignIn.next(false);
        this.firstSignIn = false;
        clearTimeout(this.timeOut);
    }
    checkSession() {
        return new Observable(observable => {
            if (this.firstSignIn) {
                this.setSignIn(null, observable);
            }
            else if (localStorage.getItem('token') &&
                localStorage.getItem('expiration') &&
                localStorage.getItem('expirationDate') &&
                localStorage.getItem('refreshToken') &&
                localStorage.getItem('user') &&
                !this.firstSignIn) {
                this.validateToken().subscribe(session => {
                    this.setSignIn(session, observable);
                }, _ => {
                    this.refreshToken().subscribe(session => {
                        this.setSignIn(session, observable);
                    }, _ => {
                        this.setSignOut(observable);
                    });
                });
            }
            else {
                this.setSignOut(observable);
            }
        });
    }
    getUser() {
        return this.user;
    }
    validateToken() {
        return this.http.get(`${this.baseUrl}/auth/validate-token`, { headers: this.headers }).pipe(map((resp) => {
            const session = resp.data.session;
            delete resp.data.session;
            this.user = resp.data;
            localStorage.setItem('user', JSON.stringify(resp.data));
            return session;
        }));
    }
    refreshToken() {
        return this.http.post(`${this.baseUrl}/auth/refresh-token`, { refreshToken: localStorage.getItem('refreshToken') }).pipe(map((resp) => resp.data));
    }
    refreshSession() {
        if (this.count) {
            this.count = false;
            this.timeOut = setTimeout(() => {
                this.refreshToken().subscribe(session => {
                    localStorage.setItem('token', session.token);
                    localStorage.setItem('expiration', session.expiration.toString());
                    localStorage.setItem('expirationDate', session.expirationDate.toString());
                    this.count = true;
                    this.refreshSession();
                }, _ => {
                    this.signOut();
                });
            }, localStorage.getItem('expiration'));
        }
    }
    setSignIn(session, observable) {
        if (session) {
            localStorage.setItem('token', session.token);
            localStorage.setItem('expiration', session.expiration.toString());
            localStorage.setItem('expirationDate', session.expirationDate.toString());
        }
        this.refreshSession();
        this.onSignIn.next(true);
        observable.next(true);
    }
    setSignOut(observable) {
        this.signOut();
        observable.next(false);
    }
    get headers() {
        return new HttpHeaders().set('Authorization', `Bearer ${localStorage.getItem('token')}`);
    }
}
SessionService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.1.2", ngImport: i0, type: SessionService, deps: [{ token: i1.HttpClient }, { token: 'baseUrl' }], target: i0.ɵɵFactoryTarget.Injectable });
SessionService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.1.2", ngImport: i0, type: SessionService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.1.2", ngImport: i0, type: SessionService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: undefined, decorators: [{
                    type: Inject,
                    args: ['baseUrl']
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctdXJ4bml1bS9zcmMvbGliL3NlcnZpY2VzL3Nlc3Npb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsZUFBZSxFQUFFLFVBQVUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUMvRCxPQUFPLEVBQWMsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFL0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFLckMsTUFBTSxPQUFPLGNBQWM7SUFTekIsWUFDVSxJQUFnQixFQUNHLE9BQWU7UUFEbEMsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNHLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFFMUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztRQUN6QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxNQUFNLENBQUMsT0FBZ0IsRUFBRSxJQUFTO1FBQ2hDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QyxZQUFZLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDbEUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsY0FBYyxD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WUFDWCxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDN0MsWUFBWSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1lBQ2xFLFlBQVksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1NBQzNFO1FBRUQsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pCLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVPLFVBQVUsQ0FBQyxVQUErQjtRQUNoRCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDZixVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxJQUFZLE9BQU87UUFDakIsT0FBTyxJQUFJLFdBQVcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsVUFBVSxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzRixDQUFDOzsyR0FySVUsY0FBYyw0Q0FXZixTQUFTOytHQVhSLGNBQWMsY0FGYixNQUFNOzJGQUVQLGNBQWM7a0JBSDFCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFZSSxNQUFNOzJCQUFDLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgU3Vic2NyaWJlciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBTZXNzaW9uIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zZXNzaW9uJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgU2Vzc2lvblNlcnZpY2Uge1xuXG4gIHB1YmxpYyBvblNpZ25JbjogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+O1xuXG4gIHByaXZhdGUgY291bnQ6IGJvb2xlYW47XG4gIHByaXZhdGUgZmlyc3RTaWduSW46IGJvb2xlYW47XG4gIHByaXZhdGUgdXNlcjogYW55O1xuICBwcml2YXRlIHRpbWVPdXQ6IGFueTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgQEluamVjdCgnYmFzZVVybCcpIHByaXZhdGUgYmFzZVVybDogc3RyaW5nXG4gICkge1xuICAgIHRoaXMub25TaWduSW4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KGZhbHNlKTtcbiAgICB0aGlzLmNvdW50ID0gdHJ1ZTtcbiAgICB0aGlzLmZpcnN0U2lnbkluID0gZmFsc2U7XG4gICAgdGhpcy51c2VyID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlcicpKTtcbiAgfVxuXG4gIHNpZ25JbihzZXNzaW9uOiBTZXNzaW9uLCB1c2VyOiBhbnkpOiB2b2lkIHtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndG9rZW4nLCBzZXNzaW9uLnRva2VuKTtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZXhwaXJhdGlvbicsIHNlc3Npb24uZXhwaXJhdGlvbi50b1N0cmluZygpKTtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZXhwaXJhdGlvbkRhdGUnLCBzZXNzaW9uLmV4cGlyYXRpb25EYXRlLnRvU3RyaW5nKCkpO1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdyZWZyZXNoVG9rZW4nLCBzZXNzaW9uLnJlZnJlc2hUb2tlbik7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3VzZXInLCBKU09OLnN0cmluZ2lmeSh1c2VyKSk7XG5cbiAgICB0aGlzLnVzZXIgPSB1c2VyO1xuICAgIHRoaXMub25TaWduSW4ubmV4dCh0cnVlKTtcbiAgICB0aGlzLmZpcnN0U2lnbkluID0gdHJ1ZTtcbiAgfVxuXG4gIHNpZ25PdXQoKTogdm9pZCB7XG4gICAgbG9jYWxTdG9yYWdlLmNsZWFyKCk7XG4gICAgdGhpcy5vblNpZ25Jbi5uZXh0KGZhbHNlKTtcbiAgICB0aGlzLmZpcnN0U2lnbkluID0gZmFsc2U7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZU91dCk7XG4gIH1cblxuICBjaGVja1Nlc3Npb24oKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9ic2VydmFibGUgPT4ge1xuICAgICAgaWYgKHRoaXMuZmlyc3RTaWduSW4pIHtcbiAgICAgICAgdGhpcy5zZXRTaWduSW4obnVsbCwgb2JzZXJ2YWJsZSk7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndG9rZW4nKSAmJlxuICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZXhwaXJhdGlvbicpICYmXG4gICAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdleHBpcmF0aW9uRGF0ZScpICYmXG4gICAgICAgIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdyZWZyZXNoVG9rZW4nKSAmJlxuICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlcicpICYmXG4gICAgICAgICF0aGlzLmZpcnN0U2lnbkluXG4gICAgICApIHtcbiAgICAgICAgdGhpcy52YWxpZGF0ZVRva2VuKCkuc3Vic2NyaWJlKFxuICAgICAgICAgIHNlc3Npb24gPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRTaWduSW4oc2Vzc2lvbiwgb2JzZXJ2YWJsZSk7XG4gICAgICAgICAgfSwgXyA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlZnJlc2hUb2tlbigpLnN1YnNjcmliZShzZXNzaW9uID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5zZXRTaWduSW4oc2Vzc2lvbiwgb2JzZXJ2YWJsZSk7XG4gICAgICAgICAgICB9LCBfID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5zZXRTaWduT3V0KG9ic2VydmFibGUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zZXRTaWduT3V0KG9ic2VydmFibGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0VXNlcigpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLnVzZXI7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlVG9rZW4oKTogT2JzZXJ2YWJsZTxTZXNzaW9uPiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoXG4gICAgICBgJHt0aGlzLmJhc2VVcmx9L2F1dGgvdmFsaWRhdGUtdG9rZW5gLFxuICAgICAgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfVxuICAgICkucGlwZShtYXAoKHJlc3A6IGFueSkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbiA9IHJlc3AuZGF0YS5zZXNzaW9uO1xuICAgICAgZGVsZXRlIHJlc3AuZGF0YS5zZXNzaW9uO1xuXG4gICAgICB0aGlzLnVzZXIgPSByZXNwLmRhdGE7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcicsIEpTT04uc3RyaW5naWZ5KHJlc3AuZGF0YSkpO1xuXG4gICAgICByZXR1cm4gc2Vzc2lvbjtcbiAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIHJlZnJlc2hUb2tlbigpOiBPYnNlcnZhYmxlPFNlc3Npb24+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QoXG4gICAgICBgJHt0aGlzLmJhc2VVcmx9L2F1dGgvcmVmcmVzaC10b2tlbmAsXG4gICAgICB7IHJlZnJlc2hUb2tlbjogbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3JlZnJlc2hUb2tlbicpIH1cbiAgICApLnBpcGUobWFwKChyZXNwOiBhbnkpID0+IHJlc3AuZGF0YSBhcyBTZXNzaW9uKSk7XG4gIH1cblxuICBwcml2YXRlIHJlZnJlc2hTZXNzaW9uKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNvdW50KSB7XG4gICAgICB0aGlzLmNvdW50ID0gZmFsc2U7XG5cbiAgICAgIHRoaXMudGltZU91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnJlZnJlc2hUb2tlbigpLnN1YnNjcmliZShcbiAgICAgICAgICBzZXNzaW9uID0+IHtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd0b2tlbicsIHNlc3Npb24udG9rZW4pO1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2V4cGlyYXRpb24nLCBzZXNzaW9uLmV4cGlyYXRpb24udG9TdHJpbmcoKSk7XG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZXhwaXJhdGlvbkRhdGUnLCBzZXNzaW9uLmV4cGlyYXRpb25EYXRlLnRvU3RyaW5nKCkpO1xuXG4gICAgICAgICAgICB0aGlzLmNvdW50ID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaFNlc3Npb24oKTtcbiAgICAgICAgICB9LCBfID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2lnbk91dCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0sIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdleHBpcmF0aW9uJykgYXMgdW5rbm93biBhcyBudW1iZXIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0U2lnbkluKHNlc3Npb246IFNlc3Npb24sIG9ic2VydmFibGU6IFN1YnNjcmliZXI8Ym9vbGVhbj4pOiB2b2lkIHtcbiAgICBpZiAoc2Vzc2lvbikge1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3Rva2VuJywgc2Vzc2lvbi50b2tlbik7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZXhwaXJhdGlvbicsIHNlc3Npb24uZXhwaXJhdGlvbi50b1N0cmluZygpKTtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdleHBpcmF0aW9uRGF0ZScsIHNlc3Npb24uZXhwaXJhdGlvbkRhdGUudG9TdHJpbmcoKSk7XG4gICAgfVxuXG4gICAgdGhpcy5yZWZyZXNoU2Vzc2lvbigpO1xuICAgIHRoaXMub25TaWduSW4ubmV4dCh0cnVlKTtcbiAgICBvYnNlcnZhYmxlLm5leHQodHJ1ZSk7XG4gIH1cblxuICBwcml2YXRlIHNldFNpZ25PdXQob2JzZXJ2YWJsZTogU3Vic2NyaWJlcjxib29sZWFuPik6IHZvaWQge1xuICAgIHRoaXMuc2lnbk91dCgpO1xuICAgIG9ic2VydmFibGUubmV4dChmYWxzZSk7XG4gIH1cblxuICBwcml2YXRlIGdldCBoZWFkZXJzKCk6IEh0dHBIZWFkZXJzIHtcbiAgICByZXR1cm4gbmV3IEh0dHBIZWFkZXJzKCkuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke2xvY2FsU3RvcmFnZS5nZXRJdGVtKCd0b2tlbicpfWApO1xuICB9XG5cbn1cbiJdfQ==